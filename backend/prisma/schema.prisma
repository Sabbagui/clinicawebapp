// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  PIX
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum MedicalRecordStatus {
  DRAFT
  FINAL
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(RECEPTIONIST)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments       Appointment[]
  medicalRecords     MedicalRecord[]
  finalizedRecords   MedicalRecord[]   @relation("FinalizedRecords")

  @@map("users")
}

model Patient {
  id        String   @id @default(uuid())
  name      String
  cpf       String   @unique
  birthDate DateTime
  phone     String
  whatsapp  String?
  email     String?

  // Address
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String

  // Emergency Contact
  emergencyContactName         String?
  emergencyContactRelationship String?
  emergencyContactPhone        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]

  @@map("patients")
}

model Appointment {
  id            String            @id @default(uuid())
  patientId     String
  patient       Patient           @relation(fields: [patientId], references: [id])
  doctorId      String
  doctor        User              @relation(fields: [doctorId], references: [id])
  scheduledDate DateTime
  duration      Int               @default(30) // in minutes
  status        AppointmentStatus @default(SCHEDULED)
  type          String // e.g., "Consulta", "Retorno", "Exame"
  notes         String?
  reminderSent  Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  medicalRecord MedicalRecord?
  payment       Payment?

  @@index([doctorId, scheduledDate])
  @@index([patientId, scheduledDate])
  @@index([status, scheduledDate])
  @@map("appointments")
}

model MedicalRecord {
  id            String              @id @default(uuid())
  patientId     String
  patient       Patient             @relation(fields: [patientId], references: [id])
  appointmentId String?             @unique
  appointment   Appointment?        @relation(fields: [appointmentId], references: [id])
  doctorId      String
  doctor        User                @relation(fields: [doctorId], references: [id])
  date          DateTime            @default(now())

  // SOAP Notes
  subjective    String              @default("")
  objective     String              @default("")
  assessment    String              @default("")
  plan          String              @default("")

  // Status
  status        MedicalRecordStatus @default(DRAFT)
  finalizedAt   DateTime?
  finalizedById String?
  finalizedBy   User?               @relation("FinalizedRecords", fields: [finalizedById], references: [id])

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("medical_records")
}

model Payment {
  id            String        @id @default(uuid())
  appointmentId String        @unique
  appointment   Appointment   @relation(fields: [appointmentId], references: [id])
  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  refundedAt    DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
  @@map("payments")
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  actorRole   String
  action      String
  entityType  String
  entityId    String
  metadata    Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId, createdAt])
  @@index([actorUserId, createdAt])
  @@map("audit_logs")
}
